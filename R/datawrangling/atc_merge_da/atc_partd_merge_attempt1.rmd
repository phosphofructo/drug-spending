---
title: "atc_medicare_merge"
author: "darya akimova"
date: "February 5, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

The goal of this work is to merge the drug names from the Medicare Part D spending data with the ATC classifications system, based on drug names. Anticipating having to clean both sets of names to get them to merge.

Packages:
```{r packages}
library(tidyverse)
library(data.world)
```

Data:
```{r data}
drug.spend.ds <- "https://data.world/data4democracy/drug-spending"
# drug names from Medicare Part D data:
d.drugs <- data.world::query(
  data.world::qry_sql("SELECT DISTINCT brand_name, generic_name FROM `spending_part_d_2011to2015_tidy`"),
  dataset = drug.spend.ds
  )
glimpse(d.drugs)
# atc classification system from drug_uses.csv
atc <- data.world::query(
  data.world::qry_sql("SELECT * FROM drug_uses"),
  dataset = drug.spend.ds
) 
glimpse(atc)
```

The ATC datasets needs some cleaning up:

```{r atc_cleanup}
atc <- atc %>% 
  select(-column_a) %>% # not useful
  select(starts_with("drug"), substance, name, everything()) %>% 
  mutate_all(str_to_lower) %>% 
  # rename some variables for clarity
  rename(
    first_level = anatomical,
    second_level = therapeutic,
    third_level = pharmacologic,
    fourth_level = chemical
    )
glimpse(atc)
# it looks like drugname_generic and substance might be identical columns, is this true?
all.equal(atc$drugname_generic, atc$substance)  # yes
# remove the substance column, rename the `name` column appropriately to what it really is - the chemical formulation
atc <- atc %>%
  select(-substance) %>% 
  rename(
    chem_formula = name
  )
glimpse(atc)
# much better
glimpse(d.drugs)
```

Time for some test merges - the low hanging fruit is:
atc - `drugname_brand` to d.drugs - `brand_name`

```{r}
brand.semi <- d.drugs %>% 
  semi_join(atc, by = c("brand_name" = "drugname_brand"))
dim(brand.semi)
```

1241 drug matches our of 4498! Not bad at all.

Will take what is left over and keep working on it:
```{r}
brand.anti <- d.drugs %>% 
  anti_join(atc, by = c("brand_name" = "drugname_brand")) %>% 
  arrange(brand_name)
glimpse(brand.anti)
```

Future problems ahead include:
- instruments vs drugs (needles, the like)
- multiple drug ingredients in the generic_name column 

On and further
```{r}
generic.semi <- brand.anti %>% 
  semi_join(atc, by = c("generic_name" = "drugname_generic"))
dim(generic.semi)
# whump whump
chem.semi <- brand.anti %>% 
  semi_join(atc, by = c("generic_name" = "chem_formula"))
dim(chem.semi)
chem.anti <- brand.anti %>% 
  anti_join(atc, by = c("generic_name" = "chem_formula"))
dim(chem.anti)
```

That is 84 more than before, I suppose. A little less than what I was hoping for.

Break 1:

```{r}
matched.so.far <- brand.semi %>% 
  bind_rows(chem.semi)
dim(matched.so.far)
# write_csv(matched.so.far, "medicareD_matched_1325.csv")
# write_csv(chem.anti, "medicareD_unmatched_3173.csv")
```

